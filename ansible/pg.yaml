- hosts: pg
  become: yes

  vars:
    docker_users:
      - "{{ ansible_user }}"
    home_dir: "/home/{{ ansible_user }}"

  handlers:
    - name: Restart SSH
      systemd:
        name: ssh
        state: restarted

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        upgrade: dist
      tags: [security, docker]

    # --------------------
    # Base Security
    # --------------------

    - name: Install security packages
      apt:
        name:
          - fail2ban
          - ufw
        state: present
      tags: [security]

    - name: Harden SSH config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
      notify: Restart SSH
      tags: [security]

    - name: Allow OpenSSH
      ufw:
        rule: allow
        name: OpenSSH
      tags: [security]

    - name: Allow PgBouncer
      ufw:
        rule: allow
        port: '6432'
        proto: tcp
      tags: [security]

    - name: Enable UFW
      ufw:
        state: enabled
        policy: deny
      tags: [security]

    # --------------------
    # Docker Installation
    # --------------------

    - name: Install Docker dependencies
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
      tags: [docker]

    - name: Create Docker keyring directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [docker]

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
        gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      tags: [docker]

    - name: Add Docker repo
      apt_repository:
        repo: >
          deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}
          signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu
          {{ ansible_distribution_release }} stable
        state: present
      tags: [docker]

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      tags: [docker]

    - name: Ensure Docker running
      systemd:
        name: docker
        enabled: yes
        state: started
      tags: [docker]

    - name: Add users to docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_users }}"
      tags: [docker]

    # --------------------
    # Platform Deployment
    # --------------------

    - name: Copy platform directory
      copy:
        src: ../platform/
        dest: "{{ home_dir }}/platform/"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      tags: [platform]

    - name: Template .env from vault
      template:
        src: templates/env.j2
        dest: "{{ home_dir }}/platform/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      tags: [platform]

    - name: Copy scripts directory
      copy:
        src: ../scripts/
        dest: "{{ home_dir }}/scripts/"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      tags: [platform]

    - name: Start platform services
      command: docker compose up -d
      args:
        chdir: "{{ home_dir }}/platform"
      become_user: "{{ ansible_user }}"
      tags: [platform]

    # --------------------
    # Project Provisioning
    # --------------------

    - name: Wait for PostgreSQL to be ready
      command: docker exec pg-core pg_isready -U postgres
      register: pg_ready
      retries: 10
      delay: 3
      until: pg_ready.rc == 0
      changed_when: false
      tags: [projects]

    - name: Provision project database and user
      shell: |
        docker exec -i pg-core psql -U postgres <<'EOF'
        DO $$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ item.name }}') THEN
            CREATE DATABASE {{ item.name }};
          END IF;
        END $$;
        DO $$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ item.name }}_user') THEN
            CREATE USER {{ item.name }}_user WITH PASSWORD '{{ project_passwords[item.name] }}';
          END IF;
        END $$;
        GRANT ALL PRIVILEGES ON DATABASE {{ item.name }} TO {{ item.name }}_user;
        EOF
      loop: "{{ projects }}"
      changed_when: false
      tags: [projects]

    - name: Grant schema public to project users
      shell: >
        docker exec -i pg-core psql -U postgres -d {{ item.name }} -c
        "GRANT ALL ON SCHEMA public TO {{ item.name }}_user"
      loop: "{{ projects }}"
      changed_when: false
      tags: [projects]

    # --------------------
    # Backup Schedule
    # --------------------

    - name: Schedule daily backup
      cron:
        name: pg-backup
        minute: "0"
        hour: "3"
        job: "{{ home_dir }}/scripts/backup.sh >> {{ home_dir }}/scripts/backup.log 2>&1"
        user: "{{ ansible_user }}"
      tags: [platform]
