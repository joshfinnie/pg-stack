- name: Copy platform directory
  copy:
    src: ../platform/
    dest: "{{ home_dir }}/platform/"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  tags: [platform]

- name: Template .env from vault
  template:
    src: templates/env.j2
    dest: "{{ home_dir }}/platform/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  tags: [platform]

- name: Copy scripts directory
  copy:
    src: ../scripts/
    dest: "{{ home_dir }}/scripts/"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  tags: [platform]

- name: Start platform services
  command: docker compose up -d
  args:
    chdir: "{{ home_dir }}/platform"
  become_user: "{{ ansible_user }}"
  tags: [platform]

- name: Schedule daily backup
  cron:
    name: pg-backup
    minute: "0"
    hour: "3"
    job: "{{ home_dir }}/scripts/backup.sh >> {{ home_dir }}/scripts/backup.log 2>&1"
    user: "{{ ansible_user }}"
  tags: [platform]
